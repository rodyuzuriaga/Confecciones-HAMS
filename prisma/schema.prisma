// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

model Pais {
  idPais    Int    @id @default(autoincrement())
  nombrePais String @unique
  departamentos Departamento[]
}

model Departamento {
  idDepartamento   Int    @id @default(autoincrement())
  nombreDepartamento String
  idPais          Int
  pais            Pais   @relation(fields: [idPais], references: [idPais])
  provincias      Provincia[]
}

model Provincia {
  idProvincia   Int    @id @default(autoincrement())
  nombreProvincia String
  idDepartamento Int
  departamento  Departamento @relation(fields: [idDepartamento], references: [idDepartamento])
  distritos     Distrito[]
}

model Distrito {
  idDistrito   Int    @id @default(autoincrement())
  nombreDistrito String
  idProvincia Int
  provincia   Provincia @relation(fields: [idProvincia], references: [idProvincia])
  direcciones Direccion[]
}

model Sexo {
  idSexo    Int    @id @default(autoincrement())
  descripcion String @unique
  datosPersonales DatosPersonales[]
}

model EstadoCivil {
  idEstadoCivil Int    @id @default(autoincrement())
  descripcion   String @unique
  datosPersonales DatosPersonales[]
}

model Rol {
  idRol       Int    @id @default(autoincrement())
  nombreRol   String @unique
  descripcion String?
  usuarios    Usuario[]
}

model Permiso {
  idPermiso     Int    @id @default(autoincrement())
  nombrePermiso String @unique
  descripcion   String?
  usuarios      Usuario[]
}

model Usuario {
  idUsuario         Int      @id @default(autoincrement())
  nombreUsuario     String   @unique
  contrasena        String
  idRol            Int
  idPermiso        Int
  ultimoAcceso     DateTime?
  intentosFallidos Int      @default(0)
  bloqueado        Boolean  @default(false)
  tokenRecuperacion String?
  rol              Rol      @relation(fields: [idRol], references: [idRol])
  permiso          Permiso  @relation(fields: [idPermiso], references: [idPermiso])
  datosPersonales  DatosPersonales?
  inspecciones     Inspeccion[]
}

model DatosPersonales {
  idDatosPersonales Int      @id @default(autoincrement())
  idUsuario        Int      @unique
  nombres          String
  apellidos        String
  dni              String    @unique
  idSexo          Int
  idEstadoCivil    Int
  usuario          Usuario   @relation(fields: [idUsuario], references: [idUsuario])
  sexo             Sexo      @relation(fields: [idSexo], references: [idSexo])
  estadoCivil      EstadoCivil @relation(fields: [idEstadoCivil], references: [idEstadoCivil])
  correos          CorreoElectronico[]
  telefonos        Telefono[]
  direcciones      Direccion[]
}

model CorreoElectronico {
  idCorreo         Int    @id @default(autoincrement())
  idDatosPersonales Int
  correoElectronico String
  tipoCorreo       String @default("personal")
  datosPersonales  DatosPersonales @relation(fields: [idDatosPersonales], references: [idDatosPersonales])
}

model Telefono {
  idTelefono       Int    @id @default(autoincrement())
  idDatosPersonales Int
  numeroTelefono   String
  tipoTelefono     String @default("movil")
  datosPersonales  DatosPersonales @relation(fields: [idDatosPersonales], references: [idDatosPersonales])
}

model Direccion {
  idDireccion      Int    @id @default(autoincrement())
  idDatosPersonales Int
  idDistrito      Int
  calleAvenida    String
  tipoDireccion   String @default("domicilio")
  piso            String?
  numero          String
  referencia      String?
  datosPersonales DatosPersonales @relation(fields: [idDatosPersonales], references: [idDatosPersonales])
  distrito        Distrito @relation(fields: [idDistrito], references: [idDistrito])
}

// ==========================================
// SISTEMA DE CONTROL DE CALIDAD
// ==========================================

model Producto {
  idProducto              Int      @id @default(autoincrement())
  nombre                  String
  descripcion             String?
  especificacionesCalidad String?  @db.Text
  activo                  Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  inspecciones            Inspeccion[]
}

model LoteProduccion {
  idLote          Int      @id @default(autoincrement())
  numeroLote      String   @unique
  fechaCreacion   DateTime @default(now())
  cantidadTotal   Int      @default(0)
  cantidadInspeccionada Int @default(0)
  cantidadAprobada Int     @default(0)
  cantidadRechazada Int    @default(0)
  estado          String   @default("en_proceso")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  inspecciones    Inspeccion[]
}

model Inspeccion {
  idInspeccion          Int      @id @default(autoincrement())
  idLote                Int?
  idProducto            Int?
  idUsuario             Int?
  fechaInspeccion       DateTime @default(now())
  imagenBase64          String?  @db.Text
  imagenUrl             String?
  resultado             String
  recomendacion         String?
  puntuacionCalidad     Int?
  resumenAnalisis       String?  @db.Text
  notasIA               String?  @db.Text
  respuestaCompletaIA   String?  @db.Text
  tiempoAnalisisMs      Int?
  createdAt             DateTime @default(now())
  
  lote                  LoteProduccion? @relation(fields: [idLote], references: [idLote])
  producto              Producto? @relation(fields: [idProducto], references: [idProducto])
  usuario               Usuario? @relation(fields: [idUsuario], references: [idUsuario])
  defectos              Defecto[]
}

model Defecto {
  idDefecto       Int      @id @default(autoincrement())
  idInspeccion    Int
  tipo            String
  severidad       String
  ubicacion       String?
  confianza       Int?
  descripcion     String?  @db.Text
  recomendacion   String?
  createdAt       DateTime @default(now())
  
  inspeccion      Inspeccion @relation(fields: [idInspeccion], references: [idInspeccion], onDelete: Cascade)
}